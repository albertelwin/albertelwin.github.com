<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Taru</title>

		<!-- <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css"> -->

		<script src="https://www.gstatic.com/firebasejs/3.8.0/firebase.js"></script>
		<script src="db.js"></script>
		<script>
			var FORM_LABEL_WIDTH = 120;
			var FORM_FIELD_WIDTH = 240;

			function make_line_break(parent_div) {
				parent_div.innerHTML += "<br>";
			};

			function make_button(parent_div, id, caption, on_click, width) {
				var button = document.createElement("button");
				button.id = id;
				button.innerHTML = caption;
				if(width !== undefined) {
					button.style.width = width;
				}
				var padding = "2px";
				button.style.marginBottom = padding;
				button.style.marginRight = padding;
				button.style.height = "28px";
				if(on_click !== undefined) {
					button.setAttribute("onclick", on_click);
				}
				parent_div.appendChild(button);

				return button;
			};

			function make_textbox(parent_div, id, value, caption, caption_width) {
				if(caption !== undefined) {
					var label = document.createElement("div");
					label.innerHTML = caption;
					if(caption_width === undefined) {
						caption_width = FORM_LABEL_WIDTH;
					}
					label.style = "display: inline-block; width: " + caption_width + "px;";
					parent_div.appendChild(label);
				}

				var textbox = document.createElement("input");
				textbox.setAttribute("type", "text");
				textbox.id = id;
				textbox.setAttribute("value", value);
				textbox.style = "display: inline-block; margin-bottom: 2px; width: " + FORM_FIELD_WIDTH + "px;";
				parent_div.appendChild(textbox);

				return textbox;
			};

			function make_dropdown_option(dropdown, caption, value) {
				var option = document.createElement("option");
				dropdown.appendChild(option);
				option.innerHTML = caption;
				option.setAttribute("value", value);
				return option;
			};

			function make_dropdown(parent_div, id, caption, option_list, value) {
				var label = document.createElement("div");
				label.innerHTML = caption;
				label.style = "display: inline-block; width: " + FORM_LABEL_WIDTH + "px;";
				parent_div.appendChild(label);

				var dropdown = document.createElement("select");
				dropdown.id = id;
				dropdown.style = "display: inline-block; margin-bottom: 2px; width: " + (FORM_FIELD_WIDTH + 4) + "px;";
				var selected_option = make_dropdown_option(dropdown, "", "");
				for(var i = 0; i < option_list.length; i++) {
					var option_val = option_list[i];
					var option = make_dropdown_option(dropdown, option_val.caption, option_val.value);
					if(option_val.value === value) {
						selected_option = option;
					}
				}
				selected_option.setAttributeNode(document.createAttribute("selected"));
				parent_div.appendChild(dropdown);

				return dropdown;
			};

			function make_user(parent_div, user, insert_front) {
				var parent_html = "";
				if(insert_front === true) {
					parent_html = parent_div.innerHTML;
					parent_div.innerHTML = "";
				}

				var user_label = document.createElement("div");
				user_label.style = "font-weight: bold;";
				parent_div.appendChild(user_label);
				user_label.innerHTML = user.key;

				make_textbox(parent_div, user.key + "_name", user.name, "Name:");
				make_line_break(parent_div);
				make_textbox(parent_div, user.key + "_email", user.email, "Email:");
				make_line_break(parent_div);
				make_dropdown(parent_div, user.key + "_type", "Type:", DB_USER_TYPE_LIST, user.type);
				make_line_break(parent_div);
				make_textbox(parent_div, user.key + "_silver_tals", user.silver_tals, "Silver tals:");
				make_line_break(parent_div);
				make_textbox(parent_div, user.key + "_copper_tals", user.copper_tals, "Copper tals:");
				make_line_break(parent_div);
				make_textbox(parent_div, user.key + "_sodium_tals", user.sodium_tals, "Sodium tals:");
				make_line_break(parent_div);

				make_line_break(parent_div);

				parent_div.innerHTML += parent_html;
			};

			function add_user() {
				var form_div = document.getElementById("form");
				var project = form_div.__project;

				for(var i = 0; i < project.users.length; i++) {
					var user = project.users[i];
					user.name = document.getElementById(user.key + "_name").value;
					user.email = document.getElementById(user.key + "_email").value;
					user.type = document.getElementById(user.key + "_type").value;
					user.silver_tals = document.getElementById(user.key + "_silver_tals").value;
					user.copper_tals = document.getElementById(user.key + "_copper_tals").value;
					user.sodium_tals = document.getElementById(user.key + "_sodium_tals").value;
				}

				var user = db_add_project_user(project, "", "", DB_USER_DEFAULT_TYPE, 0, 0, 0);

				var users_div = document.getElementById("users");
				make_user(users_div, user, true);

				document.getElementById(user.key + "_name").focus();

				for(var i = 0; i < project.users.length; i++) {
					var user = project.users[i];
					document.getElementById(user.key + "_name").value = user.name;
					document.getElementById(user.key + "_email").value = user.email;
					document.getElementById(user.key + "_type").value = user.type;
					document.getElementById(user.key + "_silver_tals").value = user.silver_tals;
					document.getElementById(user.key + "_copper_tals").value = user.copper_tals;
					document.getElementById(user.key + "_sodium_tals").value = user.sodium_tals;
				}
			};

			function add_project() {
				var project = db_create_project("");
				open_project(project);
			};

			function open_user_project() {
				var user_key_elem = document.getElementById("user_key");
				var user_key = user_key_elem.value;
				if(user_key !== undefined && user_key !== null) {
					user_key = user_key.trim();
				}
				else {
					user_key = "";
				}
				user_key_elem.value = user_key;

				db_user_to_project_key(user_key, function(project_key) {
					if(project_key !== null) {
						open_project_by_key(project_key);
					}
				});
			};

			function open_projects() {
				var form_div = document.getElementById("form");
				form_div.innerHTML = "";

				form_div.innerHTML += "<h1 style='display: inline-block;'>Projects</h1><div style='display: inline-block; width: 5px;'></div>";
				make_button(form_div, "add_project", "+", "add_project()");
				make_line_break(form_div);

				form_div.innerHTML += "<div style='display: inline-block;'>User key: </div><div style='display: inline-block; width: 5px;'></div>";
				make_textbox(form_div, "user_key", "");
				form_div.innerHTML += "<div style='display: inline-block; width: 5px;'>";
				make_button(form_div, "open_button", "Open project", "open_user_project()");
				make_line_break(form_div);
				make_line_break(form_div);

				db_for_each_project(function(project) {
					make_button(form_div, "button_" + project.key, project.name + " [" + project.key + "]", "open_project_by_key(\"" + project.key + "\");", "300px");
					make_line_break(form_div);
				});
			};

			function save_project() {
				var form_div = document.getElementById("form");

				var project = form_div.__project;

				if(project.rev < 0) {
					project.name = document.getElementById("project_name").value;
				}
				project.description = document.getElementById("project_description").value;
				project.total_tals = document.getElementById("project_total_tals").value | 0;

				for(var i = 0; i < project.users.length; i++) {
					var user = project.users[i];
					user.name = document.getElementById(user.key + "_name").value;
					user.email = document.getElementById(user.key + "_email").value;
					user.type = document.getElementById(user.key + "_type").value;
					user.silver_tals = document.getElementById(user.key + "_silver_tals").value | 0;
					user.copper_tals = document.getElementById(user.key + "_copper_tals").value | 0;
					user.sodium_tals = document.getElementById(user.key + "_sodium_tals").value | 0;
				}

				var save_button = document.getElementById("save_button");
				save_button.disabled = true;
				var cancel_button = document.getElementById("cancel_button");
				cancel_button.disabled = true;

				db_save_project(project, function(project, error) {
					if(error === null) {
						open_projects();
					}
					else {
						save_button.disabled = false;
						cancel_button.disabled = false;
					}
				});
			};

			function open_project(project) {
				var form_div = document.getElementById("form");
				form_div.innerHTML = "";

				form_div.__project = project;

				if(project.rev < 0) {
					form_div.innerHTML += "<h1> New Project [" + project.key + "]</h1>";
					make_textbox(form_div, "project_name", project.name, "Name:");
					make_line_break(form_div);
				}
				else {
					form_div.innerHTML += "<h1 style='display: inline-block;'>" + project.name + " [" + project.key + "]" + "</h1>";
					if(project.rev > 0) {
						form.innerHTML += "<div style='display: inline-block; width: 5px;'></div><div style='display: inline-block; font-style: italic;'>Revision " + project.rev + "</div>";
					}

					make_line_break(form_div);
				}

				make_textbox(form_div, "project_description", project.description, "Description:");
				make_line_break(form_div);
				make_textbox(form_div, "project_total_tals", project.total_tals, "Total tals:");
				make_line_break(form_div);

				form_div.innerHTML += "<h2 style='display: inline-block;'>Users</h2><div style='display: inline-block; width: 5px;'>";

				make_button(form_div, "add_user", "+", "add_user()");
				make_line_break(form_div);

				var users_div = document.createElement("div");
				form_div.appendChild(users_div);
				users_div.id = "users";
				for(var i = 0; i < project.users.length; i++) {
					make_user(users_div, project.users[i]);
				}

				make_button(form_div, "save_button", "Save", "save_project();", "100px");
				make_button(form_div, "cancel_button", "Cancel", "open_projects();", "100px");
			};

			function open_project_by_key(project_key) {
				db_get_project(project_key, function(project) {
					if(project !== null) {
						open_project(project);
					}
				});
			};

			function build_database() {
				db_destroy_entire_database();

				var garden = db_create_project("Garden");
				garden.approved = true;
				garden.description = "VR Gardening Game";
				garden.total_tals = 100;
				db_add_project_user(garden, "Mal", "mal@biome.com", "creative_founder", 10, 0, 0);
				db_add_project_user(garden, "Tom", "tom@biome.com", "team_member", 10, 0, 0);
				db_add_project_user(garden, "Gaz", "gaz@biome.com", "team_member", 10, 0, 0);
				db_add_project_user(garden, "Albert", "albert@biome.com", "team_member", 10, 0, 0);
				db_save_project(garden);

				var killbox = db_create_project("Killbox");
				killbox.approved = true;
				killbox.description = "A Game of Drones";
				killbox.total_tals = 100;
				db_add_project_user(killbox, "Mal", "mal@biome.com", "creative_founder", 10, 0, 0);
				db_add_project_user(killbox, "Tom", "tom@biome.com", "team_member", 10, 0, 0);
				db_add_project_user(killbox, "Jo", "jo@biome.com", "team_member", 10, 0, 0);
				db_add_project_user(killbox, "Albert", "albert@biome.com", "team_member", 10, 0, 0);
				db_save_project(killbox);
			};

			document.addEventListener("DOMContentLoaded", function() {
				// build_database();
				open_projects();
			});
		</script>
	</head>
	<!-- <body style="padding-left: 4px;"> -->
	<body style="font-family: Georgia;">
		<div id="form"></div>
	</body>
</html>
