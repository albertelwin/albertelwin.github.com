
<!-- TODO ✓

DOING:

TODO:
	Graph weight
	Basis matrix
	Text rendering

DONE:
	Record dates

 -->
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Albert Elwin</title>
		<style>
			::-webkit-scrollbar { display: none; width: 0 !important; }
		</style>
		<script>
			var APP = {};
			var GL = null;

			var VS = "attribute vec2 i_position; uniform vec2 scale; uniform vec2 offset; void main() { gl_Position = vec4(i_position * scale + offset, 0.0, 1.0); }";
			var FS = "precision mediump float; uniform vec4 color; void main() { gl_FragColor = color; }";

			function push_food(foods, name, kcal, good) {
				var food = { name: name, kcal: kcal, good: false, };
				if(good === true) {
					food.good = true;
				}

				foods[name] = food;
			}

			function begin_day(diary, weight) {
				var index = diary.days.length;

				var date = new Date(diary.date.valueOf());
				date.setDate(date.getDate() + index);

				var day = diary.days[index] = { items: [], kcal: 0.0, date: date, weight: 0.0, };
				if(weight) {
					day.weight = weight;
				}
			}

			function record_custom(diary, name, kcal, good) {
				var day = diary.days[diary.days.length - 1];

				var item = { name: name, kcal: kcal, good: false, };
				if(good === true) {
					item.good = true;
				}
				day.items[day.items.length] = item;

				day.kcal += kcal;
			}

			function record_food(diary, food, amount) {
				var kcal = food.kcal;
				if(amount) {
					kcal *= amount;
				}

				record_custom(diary, food.name, kcal, food.good);
			}

			function compile_shader(src, type) {
				var shader = GL.createShader(type);
				GL.shaderSource(shader, src);
				GL.compileShader(shader);

				if(!GL.getShaderParameter(shader, GL.COMPILE_STATUS)) {
					console.log(src + "\n" + GL.getShaderInfoLog(shader));
				}

				return shader;
			}

			function animation_frame(timestamp) {
				if(GL) {
					var dt = 0.0;
					if(APP.timestamp) {
						dt = (timestamp - APP.timestamp) * 0.001;
					}
					APP.timestamp = timestamp;

					var diary = APP.diary;

					var gl_canvas = APP.gl_canvas;
					var program = APP.program;
					var v_buf = APP.v_buf;

					var dirty = false;

					var canvas_width = window.innerWidth;
					var canvas_height = window.innerHeight * 0.5;

					if(gl_canvas.width !== canvas_width || gl_canvas.height != canvas_height) {
						gl_canvas.width = canvas_width;
						gl_canvas.height = canvas_height;

						dirty = true;
					}

					if(dirty) {
						var aspect = gl_canvas.width / gl_canvas.height;
						var r_aspect = 1.0 / aspect;

						GL.clearColor(0.0, 0.0, 0.0, 1.0);
						GL.viewport(0, 0, gl_canvas.width, gl_canvas.height);
						GL.clear(GL.COLOR_BUFFER_BIT);

						var good_color = { r: 0.0, g: 1.0, b: 0.5, };
						var bad_color = { r: 1.0, g: 0.0, b: 0.25, };

						//TODO: Build a basis matrix for the graph!!
						var width = 0.02 * r_aspect;
						var pad = 0.01;
						var r_range = 1.0 / APP.max_kcal;

						for(var day_index = 0; day_index < diary.days.length; day_index++) {
							var day = diary.days[day_index];

							var x = -1.0 + (width * 2.0 + pad * r_aspect * 3.0) * (day_index + 0.5);
							var y = -1.0;

							for(var i = 0; i < day.items.length; i++) {
								var item = day.items[i];

								var height = item.kcal * r_range;
								var color = item.good ? good_color : bad_color;

								GL.uniform2f(program.scale, width, height);
								GL.uniform2f(program.offset, x, y + height);
								GL.uniform4f(program.color, color.r, color.g, color.b, 1.0);
								GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);

								y += height * 2.0;

								GL.uniform2f(program.scale, width, pad * 0.5);
								GL.uniform2f(program.offset, x, y);
								GL.uniform4f(program.color, 0.0, 0.0, 0.0, 1.0);
								GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);
							}
						}

						GL.uniform2f(program.scale, 1.0, pad * 0.25);
						GL.uniform2f(program.offset, 0.0, -1.0 + (APP.kcal_target * r_range) * 2.0);
						GL.uniform4f(program.color, bad_color.r, bad_color.g, bad_color.b, 1.0);
						GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);
					}

					window.requestAnimationFrame(animation_frame);
				}
			}

			window.onload = function() {
				APP.kcal_target = 1500.0;
				APP.max_kcal = 4500.0;

				var foods = {};
				push_food(foods, "apple", 50, true);
				push_food(foods, "bread", 100, true);
				push_food(foods, "egg_roll", 350, true);
				push_food(foods, "crisps", 500);
				push_food(foods, "stroopwaffel", 180);
				push_food(foods, "apple_pie", 550);
				push_food(foods, "samosa", 227, true);
				push_food(foods, "baxter_country", 145, true);
				push_food(foods, "baxter_lentil", 172, true);
				push_food(foods, "porridge", 92, true);
				push_food(foods, "oatcake", 46, true);

				var diary = APP.diary = { days: [], date: new Date(2016, 11, 9), };

				begin_day(diary, 79.37866);
				record_food(diary, foods.egg_roll);
				record_food(diary, foods.bread, 6);
				record_custom(diary, "ramen", 400);
				record_custom(diary, "chips", 500);

				begin_day(diary);
				record_food(diary, foods.crisps, 0.5);
				record_custom(diary, "poached_eggs_on_toast", 800, true);
				record_food(diary, foods.egg_roll, 2);
				record_custom(diary, "hot_dog_and_onion_rings", 800);
				record_food(diary, foods.stroopwaffel, 5);
				record_food(diary, foods.apple_pie);

				begin_day(diary);
				record_custom(diary, "mozzarella_and_pesto_sandwich", 800, true);
				record_custom(diary, "egg_and_cheese_on_bread", 400, true);
				record_food(diary, foods.apple_pie);
				record_custom(diary, "veggie_burger", 600, true);
				record_custom(diary, "chocolate_waffle", 500);

				begin_day(diary);
				record_custom(diary, "apple_crumble_pancakes", 800);
				record_custom(diary, "pesto_pasta", 600, true);
				record_food(diary, foods.stroopwaffel, 6);

				begin_day(diary);
				record_food(diary, foods.stroopwaffel, 2);
				record_custom(diary, "fried_egg_croissant", 500, true);
				record_custom(diary, "apple_donut", 450);
				record_custom(diary, "mini_stroopwaffles", 700);
				record_custom(diary, "pizza", 800, true);
				record_food(diary, foods.apple_pie);

				begin_day(diary);
				record_food(diary, foods.samosa, 2);
				record_custom(diary, "tomato_soup", 200, true);
				record_custom(diary, "sweet", 100);
				record_food(diary, foods.crisps);
				record_food(diary, foods.baxter_lentil);

				begin_day(diary, 77.47358);
				record_food(diary, foods.crisps);
				record_custom(diary, "lentil_soup", 200, true);
				record_custom(diary, "bread", 300, true);
				record_custom(diary, "nandos_veggie_burger", 463, true);

				begin_day(diary, 76.83855);

				var kcal_balance = 0.0;
				var kcal_streak = 0;

				var text_box = document.getElementById("text_box");
				text_box.innerHTML = "";

				var detail_html = "";

				for(var day_index = 0; day_index < diary.days.length; day_index++) {
					var day = diary.days[day_index];
					for(var i = 0; i < day.items.length; i++) {
						var item = day.items[i];
					}

					var budget = APP.kcal_target - day.kcal;
					kcal_balance += budget;

					if(budget >= 0.0) {
						kcal_streak++;
					}
					else {
						kcal_streak = 0;
					}

					var kg_fixed = day.weight.toFixed(1);
					var kg_str = kg_fixed < 10 ? "0" + kg_fixed : kg_fixed;

					var utc_day = day.date.getUTCDate() + 1;
					var utc_month = day.date.getUTCMonth() + 1;
					var utc_year = day.date.getUTCFullYear() % 100;

					var date_str = (utc_day < 10 ? "0" + utc_day : utc_day) + "/" + (utc_month < 10 ? "0" + utc_month : utc_month) + "/" + (utc_year < 10 ? "0" + utc_year : utc_year);
					detail_html = "&nbsp;" + date_str + " <b>·</b> " + kg_str + "kg <b>·</b> " + day.kcal + " (" + budget + ")<br>" + detail_html;
				}

				text_box.innerHTML += "&nbsp;Balance: " + kcal_balance + "<br>";
				text_box.innerHTML += "&nbsp;&nbsp;Streak: " + kcal_streak + "<br><br>";
				text_box.innerHTML += detail_html;

				var gl_canvas = APP.gl_canvas = document.getElementById("gl_canvas");

				//TODO: What do all of these do??
				var gl_attribs = {
					alpha: false,
					depth: true,
					stencil: true,
					antialias: true,
					premultipliedAlpha: true,
					preserveDrawingBuffer: false,
				};

				GL = gl_canvas.getContext("webgl", gl_attribs) || gl_canvas.getContext("experimental-webgl", gl_attribs);
				if(GL) {
					var vs = compile_shader(VS, GL.VERTEX_SHADER);
					var fs = compile_shader(FS, GL.FRAGMENT_SHADER);

					var program = APP.program = { id: null, i_position: 0, };
					program.id = GL.createProgram();
					GL.attachShader(program.id, vs);
					GL.attachShader(program.id, fs);
					GL.linkProgram(program.id);

					if(!GL.getProgramParameter(program.id, GL.LINK_STATUS)) {
						console.log(GL.getProgramInfoLog(program.id));
					}

					GL.useProgram(program.id);

					program.i_position = GL.getAttribLocation(program.id, "i_position");
					program.scale = GL.getUniformLocation(program.id, "scale");
					program.offset = GL.getUniformLocation(program.id, "offset");
					program.color = GL.getUniformLocation(program.id, "color");

					var v_dat = new Float32Array([
						 1.0, 1.0,
						-1.0, 1.0,
						-1.0,-1.0,

						 1.0, 1.0,
						-1.0,-1.0,
						 1.0,-1.0,
					]);

					var v_buf = APP.v_buf = { id: null, count: 0, };
					v_buf.id = GL.createBuffer();
					v_buf.count = v_dat.length / 2;
					GL.bindBuffer(GL.ARRAY_BUFFER, v_buf.id);
					GL.bufferData(GL.ARRAY_BUFFER, v_dat, GL.STATIC_DRAW);

					GL.vertexAttribPointer(program.i_position, 2, GL.FLOAT, false, 0, 0);
					GL.enableVertexAttribArray(program.i_position);

					APP.timestamp = null;
					window.requestAnimationFrame(animation_frame);
				}
				else {
					//TODO: ERROR!!
				}
			}
		</script>
	</head>

	<body style="background-color: #000000; padding: 0; margin: 0;">
		<canvas id="gl_canvas" width="0" height="0" style="padding: 0; margin: 0;"></canvas>
		<div id="text_box" style="font-family: Courier New, monospace; font-size: 10pt; color: #FFFFFF"></div>
	</body>
</html>