
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Albert Elwin</title>
		<style>
			::-webkit-scrollbar { display: none; width: 0 !important; }
		</style>
		<script>
			var GL = null;

			var VS = "attribute vec2 i_position; uniform vec2 scale; uniform vec2 offset; void main() { gl_Position = vec4(i_position * scale + offset, 0.0, 1.0); }";
			var FS = "precision mediump float; uniform vec4 color; void main() { gl_FragColor = color; }";

			function push_food(foods, name, kcal, good) {
				var food = { name: name, kcal: kcal, good: false, };
				if(good === true) {
					food.good = true;
				}

				foods[name] = food;
			}

			function begin_day(diary, weight) {
				diary[diary.length] = { items: [], kcal: 0.0, weight: weight, };
			}

			function record_custom(diary, name, kcal, good) {
				var day = diary[diary.length - 1];

				var item = { name: name, kcal: kcal, good: false, };
				if(good === true) {
					item.good = true;
				}
				day.items[day.items.length] = item;

				day.kcal += kcal;
			}

			function record_food(diary, food, amount) {
				var kcal = food.kcal;
				if(amount) {
					kcal *= amount;
				}

				record_custom(diary, food.name, kcal, food.good);
			}

			function compile_shader(src, type) {
				var shader = GL.createShader(type);
				GL.shaderSource(shader, src);
				GL.compileShader(shader);

				if(!GL.getShaderParameter(shader, GL.COMPILE_STATUS)) {
					console.log(src + "\n" + GL.getShaderInfoLog(shader));
				}

				return shader;
			}

			window.onload = function() {
				var gl_canvas = document.getElementById("gl_canvas");
				gl_canvas.width = window.innerWidth;
				gl_canvas.height = window.innerHeight;

				var foods = {};
				push_food(foods, "apple", 50, true);
				push_food(foods, "bread", 100, true);
				push_food(foods, "ramen", 400);
				push_food(foods, "fried_egg", 150, true);
				push_food(foods, "egg_roll", 350, true);
				push_food(foods, "crisps", 200);
				push_food(foods, "stroopwaffel", 180);
				push_food(foods, "samosa", 227, true);

				var diary = [];

				begin_day(diary, 80.0);
				record_food(diary, foods.egg_roll);
				record_food(diary, foods.bread, 6);
				record_food(diary, foods.ramen);
				record_custom(diary, "chips", 500);

				begin_day(diary, 0.0);
				record_food(diary, foods.crisps);
				record_custom(diary, "poached_eggs_on_toast", 800, true);
				record_food(diary, foods.egg_roll, 2);
				record_custom(diary, "hot_dog_and_onion_rings", 800);
				record_food(diary, foods.stroopwaffel, 5);
				record_custom(diary, "apple_pie", 550);

				begin_day(diary, 0.0);
				record_custom(diary, "mozzarella_and_pesto_sandwich", 800, true);
				record_custom(diary, "egg_and_cheese_on_bread", 400, true);
				record_custom(diary, "veggie_burger", 600, true);
				record_custom(diary, "chocolate_waffle", 500);

				begin_day(diary, 0.0);
				record_custom(diary, "apple_crumble_pancakes", 800);
				record_custom(diary, "pesto_pasta", 600);
				record_food(diary, foods.stroopwaffel, 6);

				begin_day(diary, 0.0);
				record_food(diary, foods.stroopwaffel, 2);
				record_custom(diary, "fried_egg_croissant", 500, true);
				record_custom(diary, "apple_donut", 450);
				record_custom(diary, "mini_stroopwaffles", 700);
				record_custom(diary, "pizza", 800, true);
				record_custom(diary, "apple_pie", 550);

				begin_day(diary, 0.0);
				record_food(diary, foods.samosa, 2);
				record_custom(diary, "tomato_soup", 200.0, true);
				record_custom(diary, "sweet", 100.0, false);

				for(var day_index = 0; day_index < diary.length; day_index++) {
					var day = diary[day_index];
					for(var i = 0; i < day.items.length; i++) {
						var item = day.items[i];
					}
					console.log("total_kcal: " + day.kcal);
				}

				//TODO: What do all of these do??
				var gl_attribs = {
					alpha: false,
					depth: true,
					stencil: true,
					antialias: true,
					premultipliedAlpha: true,
					preserveDrawingBuffer: false,
				};

				GL = gl_canvas.getContext("webgl", gl_attribs) || gl_canvas.getContext("experimental-webgl", gl_attribs);
				if(GL) {
					var aspect = gl_canvas.width / gl_canvas.height;
					var r_aspect = 1.0 / aspect;

					GL.clearColor(0.0, 0.0, 0.0, 1.0);
					GL.viewport(0, 0, gl_canvas.width, gl_canvas.height);
					GL.clear(GL.COLOR_BUFFER_BIT);

					var vs = compile_shader(VS, GL.VERTEX_SHADER);
					var fs = compile_shader(FS, GL.FRAGMENT_SHADER);

					var program = { id: null, i_position: 0, };
					program.id = GL.createProgram();
					GL.attachShader(program.id, vs);
					GL.attachShader(program.id, fs);
					GL.linkProgram(program.id);

					if(!GL.getProgramParameter(program.id, GL.LINK_STATUS)) {
						console.log(GL.getProgramInfoLog(program.id));
					}

					GL.useProgram(program.id);

					program.i_position = GL.getAttribLocation(program.id, "i_position");
					program.scale = GL.getUniformLocation(program.id, "scale");
					program.offset = GL.getUniformLocation(program.id, "offset");
					program.color = GL.getUniformLocation(program.id, "color");

					var v_dat = new Float32Array([
						 1.0, 1.0,
						-1.0, 1.0,
						-1.0,-1.0,

						 1.0, 1.0,
						-1.0,-1.0,
						 1.0,-1.0,
					]);

					var v_buf = { id: null, count: 0, };
					v_buf.id = GL.createBuffer();
					v_buf.count = v_dat.length / 2;
					GL.bindBuffer(GL.ARRAY_BUFFER, v_buf.id);
					GL.bufferData(GL.ARRAY_BUFFER, v_dat, GL.STATIC_DRAW);

					GL.vertexAttribPointer(program.i_position, 2, GL.FLOAT, false, 0, 0);
					GL.enableVertexAttribArray(program.i_position);

					var good_color = { r: 0.0, g: 1.0, b: 0.5, };
					var bad_color = { r: 1.0, g: 0.0, b: 0.25, };

					//TODO: Build a basis matrix for the graph!!
					var width = 0.02 * r_aspect;
					var pad = 0.01;
					var range = 5000.0;
					var r_range = 1.0 / range;

					//TODO: Fix this!!
					for(var day_index = 0; day_index < diary.length; day_index++) {
						var day = diary[day_index];

						var x = -1.0 + (width * 2.0 + pad * r_aspect * 3.0) * (day_index + 0.5);
						var y = -1.0;

						for(var i = 0; i < day.items.length; i++) {
							var item = day.items[i];

							var height = item.kcal * r_range;
							var color = item.good ? good_color : bad_color;

							GL.uniform2f(program.scale, width, height);
							GL.uniform2f(program.offset, x, y + height);
							GL.uniform4f(program.color, color.r, color.g, color.b, 1.0);
							GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);

							y += height * 2.0;

							GL.uniform2f(program.scale, width, pad * 0.5);
							GL.uniform2f(program.offset, x, y);
							GL.uniform4f(program.color, 0.0, 0.0, 0.0, 1.0);
							GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);
						}
					}

					var kcal_target = 1500.0;

					GL.uniform2f(program.scale, 1.0, pad * 0.25);
					GL.uniform2f(program.offset, 0.0, -1.0 + (kcal_target * r_range) * 2.0);
					GL.uniform4f(program.color, bad_color.r, bad_color.g, bad_color.b, 1.0);
					GL.drawArrays(GL.TRIANGLES, 0, v_buf.count);
				}
				else {
					//TODO: ERROR!!
				}
			}
		</script>
	</head>

	<body style="background-color: #000000; padding: 0; margin: 0;">
		<canvas id="gl_canvas" width="1280" height="720" style="padding: 0; margin: 0;"></canvas>
	</body>
</html>